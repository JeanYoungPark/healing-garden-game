# 🐰 동물 방문 시스템

힐링 가든의 동물 방문 시스템 문서

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [동물 등장 조건](#동물-등장-조건)
3. [랜덤 재등장 시스템](#랜덤-재등장-시스템)
4. [대기열 시스템](#대기열-시스템)
5. [동물 목록](#동물-목록)
6. [구현 상태](#구현-상태)

---

## 시스템 개요

### 핵심 메커니즘

**동물 방문 유형**:
1. **조건 기반 방문**: 특정 조건 만족 시 처음 등장
2. **랜덤 재등장**: 이미 만난 동물이 랜덤하게 다시 방문

### 방문 제한

- **하루 최대 2회** 랜덤 재등장 (조건 기반 방문은 제외)
- **자정(00:00) 기준** 일일 카운트 리셋
- **조건 동물 우선**: 조건 동물이 대기 중이면 랜덤 동물 패스

---

## 동물 등장 조건

### 조건 타입

#### 1. harvest (작물 수확)
특정 작물 첫 수확 시 즉시 등장

**예시**:
- 당근 수확 → 토끼 등장

#### 2. time (시간 기반)
게임 시작 또는 특정 이벤트 후 경과 시간

**예시** (계획):
- 게임 시작 7일 후 → 거북이 등장
- 게임 시작 5일 후 랜덤 → 여우 등장

#### 3. count (누적 횟수)
특정 행동 누적 횟수 달성

**예시** (계획):
- 누적 수확 500회 → 너구리 등장
- 물 사용 10회 이상 → 개구리 등장

#### 4. condition (특수 조건)
복합 조건 또는 특수한 상황

**예시** (계획):
- 밭에 3종 이상 동시 재배 → 사슴 등장
- 수확 없이 앱 접속 2회 → 고양이 등장

#### 5. after (다른 동물 후)
특정 동물 방문 후 랜덤

**예시** (계획):
- 토끼 방문 후 랜덤 → 참새 등장

---

## 랜덤 재등장 시스템

### 기본 규칙

1. **이미 만난 동물만** 랜덤 재등장 가능
2. **하루 최대 2회** (전체 합산)
3. **조건 동물 우선**: 대기열에 조건 동물 있으면 패스

### 등장 시점

- 앱 시작 시
- 포그라운드 복귀 시
- **동물 클릭 후** (중요!)

### 선물 유무

동물마다 설정이 다름:

| 선물 타입 | 설명 | 예시 |
|-----------|------|------|
| **항상 선물** | `alwaysGift: true` | 토끼 (무 씨앗 3개) |
| **선물 없음** | `neverGift: true` | - |
| **확률적** | 둘 다 false | 50% 확률로 선물 (고양이 등) |
| **랜덤 선물** | 여러 종류 중 랜덤 | 여우 (씨앗/돈/물) |

### 등장 확률

각 동물마다 개별 설정:

```typescript
randomReappear: {
  enabled: true,
  probability: 0.3,  // 30% 확률
  alwaysGift: true,
  neverGift: false,
}
```

---

## 대기열 시스템

### 우선순위

1. **조건 동물** (harvest, time, count 등)
2. **랜덤 재등장 동물**

### 대기열 규칙

- 조건 동물이 대기 중일 때는 랜덤 동물 등장 안 함
- 조건 동물 클릭 후 → 즉시 랜덤 체크
- UI에는 **현재 방문 중인 동물만** 표시 (대기열 비표시)

### 시간 간격 동물

24시간 간격이 필요한 동물:
- 거북이 (게임 시작 7일 후)
- 여우 (게임 시작 5일 후 랜덤)

**즉시 등장 동물**:
- harvest 조건: 수확 즉시
- count 조건: 조건 만족 즉시
- 랜덤 재등장: 클릭 후 즉시 체크

---

## 동물 목록

### 구현 완료

#### 🐰 토끼 (토깽이)
- **등장 조건**: 당근 첫 수확
- **첫 방문 선물**: 딸기 씨앗 1개
- **랜덤 재등장**: ✅ (30% 확률, 항상 선물)
- **재등장 선물**: 딸기 씨앗 1개
- **메시지**:
  - 첫 방문: "당근밭을 보고 반가워하는 토깽이가\n딸기 씨앗 1개를 선물로 줬어요!"
  - 재등장: "토깽이가\n딸기 씨앗 1개를 선물로 줬어요!"
- **상태**: ✅ 구현 완료

#### 🐱 고양이 (고영희)
- **등장 조건**:
  - 토끼를 만난 후
  - 수확 없이 앱 접속 2회
- **첫 방문 선물**: 물 1개
- **랜덤 재등장**: ✅ (15% 확률, 50% 확률로 선물)
- **재등장 선물**: 물 1개 (50% 확률)
- **메시지**:
  - 첫 방문: "길을 지나다 들른 고영희가\n물 1개를 선물로 줬어요!"
  - 재등장: "고영희가\n물 1개를 선물로 줬어요!"
- **상태**: ✅ 구현 완료

#### 🦉 올빼미 (올뺌희)
- **등장 조건**:
  1. 첫 수확 후 3일(72시간) 경과
  2. 토끼를 만난 후
  3. 올빼미 편지를 받고 읽음
  4. 편지를 읽은 날 자정 이후
  5. 밤 시간대(18:00~03:00)에 앱 접속
- **첫 방문 선물**: 안경 👓 (꾸미기 아이템)
- **랜덤 재등장**: ✅ (2% 확률, 항상 선물)
- **재등장 선물**: 안경 또는 물 3개 (50% 확률로 랜덤)
- **특별 규칙**:
  - 밤에만 등장 (18:00~03:00)
  - 낮 시간대에는 자동으로 사라짐
  - 낮에 클릭 시: "밤이 끝나서 올뺌희가 떠났어요"
- **편지 내용**:
  ```
  제목: 밤하늘의 친구
  발신: 올빼미

  안녕 난 올빼미야. 밤마다 이 근처를 날아다니다가
  네 밭을 보게 됐어. 작물을 정성껏 키우고 있더라.
  조만간 직접 인사하러 갈게
  ```
- **메시지**:
  - 첫 방문: "밤하늘의 친구 올뺌희가\n안경을 선물로 줬어요!"
  - 재등장 (안경): "올뺌희가\n안경을 선물로 줬어요!"
  - 재등장 (물): "올뺌희가\n물 3개를 선물로 줬어요!"
- **상태**: ✅ 구현 완료

### 구현 예정

#### 🐢 거북이 (Turtle)
- **등장 조건**: 게임 시작 7일 후
- **선물**: 딸기 씨앗 2개
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현

#### 🦔 고슴도치 (Hedgehog)
- **등장 조건**: 감자 또는 무 첫 수확
- **선물**: 수박 씨앗 2개
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현

#### 🦝 너구리 (Raccoon)
- **등장 조건**: 누적 수확 500회
- **선물**: 복숭아 씨앗 1개
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현

#### 🐸 개구리 (Frog)
- **등장 조건**: 물 사용 10회 이상
- **선물**: 포도 씨앗 1개
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현

#### 🐦 참새 (Sparrow)
- **등장 조건**: 토끼 방문 후 랜덤
- **선물**: TBD
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현 (타입도 미정의)

#### 🦊 여우 (Fox)
- **등장 조건**: 게임 시작 5일 후 랜덤
- **선물**: 랜덤 (씨앗/돈/물 중 하나)
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현 (타입도 미정의)

#### 🦌 사슴 (Deer)
- **등장 조건**: 밭에 3종 이상 동시 재배
- **선물**: TBD
- **랜덤 재등장**: TBD
- **상태**: ⏳ 미구현 (타입도 미정의)

---

## 구현 상태

### 완료된 기능 ✅

- [x] 조건 기반 동물 등장 시스템
- [x] harvest 트리거 (작물 수확)
- [x] 랜덤 재등장 시스템
- [x] 하루 2회 제한 (자정 리셋)
- [x] 대기열 우선순위 처리
- [x] 동물별 선물 유무 설정
- [x] 앱 시작/복귀 시 체크
- [x] 동물 클릭 후 랜덤 체크
- [x] 토끼 완전 구현

### 구현 대기 🔜

- [ ] time 트리거 (시간 기반)
- [ ] count 트리거 (누적 횟수)
- [ ] condition 트리거 (복합 조건)
- [ ] after 트리거 (다른 동물 후)
- [ ] 거북이 구현 (게임 시작 7일)
- [ ] 고슴도치 구현 (감자/무 수확)
- [ ] 개구리 구현 (물 10회)
- [ ] 너구리 구현 (수확 500회)
- [ ] 나머지 동물들 (참새, 고양이, 여우, 사슴)

---

## 코드 구조

### 주요 파일

```
src/
├── types/index.ts              # AnimalVisitor, AnimalType 정의
├── utils/animalConfigs.ts      # 동물 설정 (조건, 선물, 확률)
└── stores/gardenStore.ts       # 동물 로직
    ├── checkForNewVisitors()      # 조건 동물 체크
    ├── checkForRandomVisitors()   # 랜덤 재등장 체크
    ├── claimVisitor()             # 선물 수령
    └── resetDailyRandomVisits()   # 자정 리셋
```

### 타입 정의

```typescript
interface AnimalVisitor {
  type: AnimalType;
  appearedAt: Date;
  scheduledTime?: Date;  // 예약된 등장 시간 (대기열용)
  isRandom?: boolean;    // 랜덤 재등장 여부
}

interface AnimalConfig {
  type: AnimalType;
  name: string;
  giftSeedType: PlantType;
  giftSeedCount: number;
  trigger: { type: 'harvest' | 'disabled' };
  randomReappear?: {
    enabled: boolean;
    probability: number;
    alwaysGift: boolean;
    neverGift: boolean;
  };
}
```

---

## 확장 가능성

### 새 동물 추가 방법

1. **AnimalType에 타입 추가**
   ```typescript
   export type AnimalType = 'rabbit' | 'turtle' | ... | 'newAnimal';
   ```

2. **animalConfigs.ts에 설정 추가**
   ```typescript
   newAnimal: {
     type: 'newAnimal',
     name: '새 동물',
     trigger: { type: 'harvest', requiredPlant: 'strawberry' },
     randomReappear: { enabled: true, probability: 0.4, ... },
     ...
   }
   ```

3. **필요시 새 트리거 타입 구현**
   - `checkForNewVisitors()`에 로직 추가

---

**작성일**: 2026-02-11
**버전**: 1.0
**상태**: 진행 중
